<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meteor Madness üåç‚òÑ ‚Äî NASA 3D Edition</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- html2canvas for map export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Model Viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
:root {--bg:#0b1220;--panel:#101829;--panel-2:#0e1526;--acc:#00d4ff;--muted:#90a7c4;--ok:#2ecc71;--warn:#f1c40f;--danger:#e74c3c;--border:#1f2a44;}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:sans-serif;color:#eef3ff;}
body{display:grid;grid-template-columns:58% 42%;grid-template-rows:100%;background:radial-gradient(1200px 800px at 15% -10%,#14213a 0%,#0b1220 35%) fixed;}
#map{width:100%;height:100vh;border-right:1px solid var(--border);position:relative;}
.hud{position:absolute;top:16px;left:16px;display:flex;gap:12px;flex-wrap:wrap;background:rgba(16,24,41,0.7);padding:10px 12px;border-radius:14px;border:1px solid var(--border);backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(0,0,0,0.35);}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0b1220;font-size:12px;color:var(--muted);}
.legend{margin-left:auto;display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
#controls{height:100vh;overflow-y:auto;padding:16px;background:var(--panel);display:grid;grid-template-rows:auto auto auto 1fr;gap:14px;}
.card{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 18px rgba(0,0,0,.25);margin-bottom:12px;}
.output{background:#0b1327;border:1px solid var(--border);padding:10px;border-radius:10px;color:#d7e3ff;margin-top:8px;}
#viewerWrap{position:relative;height:360px;border-radius:12px;overflow:hidden;border:1px solid var(--border);}
model-viewer{width:100%;height:100%;background:radial-gradient(900px 400px at 50% 10%,#0f1b34 0%,#0b1220 60%);--poster-color:transparent;--progress-bar-color:var(--acc);}
input, select, button{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid var(--border);background:#0c1428;color:#e7efff;font-weight:600;}
button{background:var(--acc);color:#051019;border:none;cursor:pointer;transition:transform .05s ease;}
button:hover{transform: translateY(-1px);}
.extra-panel{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:12px;}
.extra-panel h4{margin:0 0 6px;font-size:14px;color:var(--acc);}
.extra-panel button{margin-top:4px;}
@media(max-width:1100px){body{grid-template-columns:1fr}#map{height:52vh}#controls{height:auto}}
</style>
</head>
<body>

<!-- LEFT: Map -->
<div id="mapWrap">
  <div id="map"></div>
  <div class="hud">
    <span class="chip">üó∫Ô∏è Click anywhere to set impact</span>
    <div class="legend">
      <span><i class="dot" style="background:#e74c3c"></i> severe</span>
      <span><i class="dot" style="background:#f39c12"></i> high</span>
      <span><i class="dot" style="background:#f1c40f"></i> medium</span>
    </div>
  </div>
</div>

<!-- RIGHT: Controls & 3D -->
<aside id="controls">
  <!-- Step 1: 3D Model -->
  <div class="card">
    <h3>Asteroid 3D Model</h3>
    <div id="viewerWrap">
      <model-viewer id="asteroidViewer"
        src="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/b/Bennu_1_1.glb"
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls shadow-intensity="1" exposure="0.9" auto-rotate
        interaction-prompt="none"></model-viewer>
    </div>
    <select id="modelPicker" style="margin-top:8px;">
      <option value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/b/Bennu_1_1.glb">(101955) Bennu</option>
      <option value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/e/Eros_1_10.glb">(433) Eros</option>
      <option value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/i/Itokawa_1_1.glb">(25143) Itokawa</option>
    </select>
  </div>

  <!-- Step 2: Simulation -->
  <div class="card">
    <h3>Simulation Controls</h3>
    <label>Asteroid Diameter (m) <input type="number" id="size" value="100"></label>
    <label>Velocity (km/s) <input type="number" id="velocity" value="20"></label>
    <label>Impact Angle (¬∞) <input type="number" id="angle" value="45"></label>
    <label>Population Density (/km¬≤) <input type="number" id="density" value="1000"></label>
    <button onclick="simulate()">‚ñ∂ Simulate Impact</button>
    <div id="output" class="output"></div>
  </div>

  <!-- Step 4: Strategy Explorer -->
  <div class="extra-panel">
    <h4>Step 4: Strategy Explorer</h4>
    <button onclick="deflectionMission()">üöÄ Deflection Mission</button>
    <button onclick="evacuationPlan()">üèÉ Evacuation Plan</button>
    <div id="strategyOutput" class="output" style="margin-top:8px;"></div>
  </div>

  <!-- Step 5: Export -->
  <div class="extra-panel">
    <h4>Step 5: Export Results</h4>
    <button onclick="exportPDF()">üìÑ Export PDF</button>
    <button onclick="exportMap()">üñºÔ∏è Export Map PNG</button>
  </div>
</aside>

<script>
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap contributors' }).addTo(map);

let impactLat=null, impactLng=null, impactMarker=null;
let lastCircle=null;

// Map click handler
map.on('click', e => {
  impactLat=e.latlng.lat; impactLng=e.latlng.lng;
  if(impactMarker) map.removeLayer(impactMarker);
  impactMarker=L.marker([impactLat,impactLng]).addTo(map).bindPopup("Impact Location").openPopup();
});

// 3D model picker
const modelPicker = document.getElementById('modelPicker');
const viewer = document.getElementById('asteroidViewer');
modelPicker.addEventListener('change',()=>{viewer.src=modelPicker.value;});

// Simulation
function simulate(){
  const size=parseFloat(document.getElementById('size').value);
  const velocity=parseFloat(document.getElementById('velocity').value);
  const angle=parseFloat(document.getElementById('angle').value)*Math.PI/180;
  const density=parseFloat(document.getElementById('density').value);

  if(impactLat===null || impactLng===null){ alert('Click on map to set impact!'); return; }

  const volume=(4/3)*Math.PI*Math.pow(size/2,3);
  const rho=3000;
  const mass=volume*rho;
  const vms=velocity*1000;
  const energy=0.5*mass*vms*vms;
  const energyMT=energy/4.184e15;
  const coupling=Math.max(0.2,Math.sin(angle));
  const effectiveMT=energyMT*coupling;
  const crater=(size*velocity/2).toFixed(1);
  const damageRadius=Math.cbrt(Math.max(0,effectiveMT))*2;
  const affectedPop=Math.round(Math.PI*Math.pow(damageRadius,2)*density/1e6);

  document.getElementById('output').innerHTML=`
    <b>Impact Results</b><br>
    Crater size: ${crater} m<br>
    Energy Released: ${effectiveMT.toFixed(2)} Mt TNT<br>
    Damage radius: ${damageRadius.toFixed(1)} km<br>
    Population affected: ~${affectedPop} million
  `;

  // Draw risk circle
  if(lastCircle) map.removeLayer(lastCircle);
  lastCircle=L.circle([impactLat,impactLng],{radius:damageRadius*1000,color:'#e74c3c',fillOpacity:0.2}).addTo(map);
}

// Strategy Explorer
function deflectionMission(){
  document.getElementById('strategyOutput').innerHTML="üöÄ Initiating asteroid deflection mission‚Ä¶ Calculating trajectory adjustments.";
}

function evacuationPlan(){
  document.getElementById('strategyOutput').innerHTML=`üèÉ Evacuation Plan Activated:<br>
Relocate population within 300 km of projected ground zero;<br>
Prioritize hospitals, schools, and transit corridors.<br>
Stage supplies upwind of predicted fallout zone.`;
}

// Export PDF
function exportPDF(){
  if(!document.getElementById('output').innerText) { alert('Run simulation first!'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Meteor Madness - Impact Report", 20, 20);
  const text = document.getElementById('output').innerText + "\n\n" + document.getElementById('strategyOutput').innerText;
  doc.setFontSize(12);
  doc.text(text, 20, 40);
  doc.save("impact_report.pdf");
}

// Export Map PNG
function exportMap(){
  html2canvas(document.getElementById('map')).then(canvas=>{
    const link=document.createElement('a');
    link.download="map.png";
    link.href=canvas.toDataURL("image/png");
    link.click();
  });
}
</script>
</body>
</html>
