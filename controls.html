<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meteor Madness üåç‚òÑ ‚Äî NASA 3D Edition</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- jsPDF -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- html2canvas for map export -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Model Viewer -->
    <script type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <style>
:root {--bg:#0b1220;--panel:#101829;--panel-2:#0e1526;--acc:#00d4ff;--muted:#90a7c4;--ok:#2ecc71;--warn:#f1c40f;--danger:#e74c3c;--border:#1f2a44;}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:sans-serif;color:#eef3ff;}
body{display:grid;grid-template-columns:58% 42%;grid-template-rows:100%;background:radial-gradient(1200px 800px at 15% -10%,#14213a 0%,#0b1220 35%) fixed;}
#map{width:100%;height:100vh;border-right:1px solid var(--border);position:relative;}
.hud{position:absolute;top:16px;left:16px;display:flex;gap:12px;flex-wrap:wrap;background:rgba(16,24,41,0.7);padding:10px 12px;border-radius:14px;border:1px solid var(--border);backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(0,0,0,0.35);}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0b1220;font-size:12px;color:var(--muted);}
.legend{margin-left:auto;display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
#controls{height:100vh;overflow-y:auto;padding:16px;background:var(--panel);display:grid;grid-template-rows:auto auto auto 1fr;gap:14px;}
.card{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 18px rgba(0,0,0,.25);margin-bottom:12px;}
.output{background:#0b1327;border:1px solid var(--border);padding:10px;border-radius:10px;color:#d7e3ff;margin-top:8px;white-space:pre-wrap;max-height:220px;overflow:auto;font-family:monospace;font-size:12px;}
#viewerWrap{position:relative;height:360px;border-radius:12px;overflow:hidden;border:1px solid var(--border);}
model-viewer{width:100%;height:100%;background:radial-gradient(900px 400px at 50% 10%,#0f1b34 0%,#0b1220 60%);--poster-color:transparent;--progress-bar-color:var(--acc);}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px;}
input, select, button, textarea{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid var(--border);background:#0c1428;color:#e7efff;font-weight:600;}
textarea{height:140px;resize:vertical;font-family:monospace;}
button{background:var(--acc);color:#051019;border:none;cursor:pointer;transition:transform .05s ease;}
button:hover{transform: translateY(-1px);}
.extra-panel{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:12px;}
.extra-panel h4{margin:0 0 6px;font-size:14px;color:var(--acc);}
.extra-panel button{margin-top:4px;}
.api-links{font-size:13px;color:var(--muted);margin-top:8px;}
.api-links a{color:var(--acc);display:block;margin:4px 0;}
.tooltip{font-size:11px;color:#90a7c4;margin-left:6px;}
.collapsible {background: var(--panel);color: var(--acc);cursor: pointer;padding:8px;width:100%;border:none;text-align:left;outline:none;font-size:12px;border-radius:8px;}
.collapsible:after {content: '\002B';color: var(--acc);float:right;margin-left:5px;}
.collapsible.active:after {content: "\2212";}
.content-collapsible {padding:0 8px;display:none;overflow:hidden;background-color:var(--panel-2);border-radius:6px;margin-top:4px;}
@media(max-width:1100px){body{grid-template-columns:1fr}#map{height:52vh}#controls{height:auto}}

/* --- NAVIGATION BAR --- */
header{position:fixed;top:0;left:0;width:100%;background:rgba(16,24,41,0.95);z-index:1000;padding:10px 20px;display:flex;gap:20px;align-items:center;backdrop-filter:blur(6px);border-bottom:1px solid var(--border);}
header a{color:#eef3ff;text-decoration:none;font-weight:bold;font-size:14px;}
header a:hover{color:#00f0ff;}
body{padding-top:50px;} /* offset for fixed header */
</style>
  </head>
  <body>

    <!-- HEADER NAV -->
    <header>
      <a href="index.html">Simulation & History</a>
      <a href="controls.html">Simulation Controls</a>
      <a href="asteroid_watch.html">NASA Asteroid Watch</a>
    </header>

    <!-- LEFT: Map -->
    <div id="mapWrap">
      <div id="map"></div>
      <div class="hud">
        <span class="chip">üó∫Ô∏è Click anywhere to set impact</span>
        <div class="legend">
          <span><i class="dot" style="background:#e74c3c"></i> severe</span>
          <span><i class="dot" style="background:#f39c12"></i> high</span>
          <span><i class="dot" style="background:#f1c40f"></i> medium</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: Controls & 3D -->
    <aside id="controls">
      <!-- 3D Model -->
      <div class="card">
        <h3>Asteroid 3D Model</h3>
        <div id="viewerWrap">
          <model-viewer id="asteroidViewer"
            src="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/b/Bennu_1_1.glb"
            ar ar-modes="webxr scene-viewer quick-look"
            camera-controls shadow-intensity="1" exposure="0.9" auto-rotate
            interaction-prompt="none"></model-viewer>
        </div>
        <select id="modelPicker" style="margin-top:8px;">
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/b/Bennu_1_1.glb">(101955)
            Bennu</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/a/Apophis_1_1.glb">Apophis</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/i/Itokawa_1_1.glb">Itokawa</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/e/Eros_1_10.glb">Eros</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/p/Psyche_1_1.glb">Psyche</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/d/Didymos_1_1.glb">Didymos
            and Dimorphos</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/i/Ida_1_1.glb">Ida
            and Dactyl</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/v/Vesta_1_1.glb">Vesta</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/yr4/2024_YR4_1_1.glb">2024
            YR4</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/dj/Donaldjohanson_1_1.glb">Donaldjohanson</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/s/Selam_1_1.glb">Selam</option>
          <option
            value="https://assets.science.nasa.gov/content/dam/science/psd/solar/2023/09/dk/Dinkinesh_1_1.glb">Dinkinesh</option>
        </select>
        <small>Tip: pick a model to visualize composition/shape. These are demo
          GLBs from NASA.</small>
      </div>

      <!-- Simulation -->
      <div class="card">
        <h3>Simulation Controls</h3>

        <div class="row">
          <div class="col">
            <label>Asteroid Name / NEO ID
              <input id="neoId" placeholder="e.g., Impactor-2025 or 101955" />
            </label>
          </div>
          <div style="width:140px">
            <label>NASA API Key
              <input id="nasaKey"
                value="pek5nQn36uT5HyKQqJdq5PRAuhcZSlbSXwePmIFe" />
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Asteroid Diameter (m)
              <input type="number" id="size" value="100" min="0.1" step="0.1" />
            </label>
          </div>
          <div class="col">
            <label>Density (kg/m¬≥)
              <input type="number" id="densityInput" value="3000" min="500"
                step="10" />
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Velocity (km/s)
              <input type="number" id="velocity" value="20" step="0.1" />
            </label>
          </div>
          <div class="col">
            <label>Impact Angle (¬∞)
              <input type="number" id="angle" value="45" step="1" />
            </label>
          </div>
        </div>

        <label>Population Density (/km¬≤)
          <input type="number" id="popDensity" value="1000" />
        </label>

        <label>Uncertainty Cone Half-Angle (¬∞)
          <input type="number" id="uncertaintyDeg" value="5" min="0" max="45" />
        </label>

        <label>Monte Carlo Samples
          <input type="number" id="samples" value="200" min="10" step="10" />
        </label>

        <label>Deflection (Œîv in m/s) ‚Äî affects energy/impact probability
          <input type="range" id="deflect" min="0" max="1000" value="0" />
          <small id="deflectVal">Œîv = 0 m/s</small>
        </label>

        <div style="display:flex;gap:8px;">
          <button onclick="fetchNEO()">üî≠ Fetch NEO</button>
          <button onclick="generateUncertaintyCone()">‚òÑÔ∏è Generate Cone</button>
          <button onclick="simulate()">‚ñ∂ Simulate Impact</button>
        </div>

        <div id="output" class="output">Run a simulation or fetch a NEO to
          begin.</div>
      </div>

      <!-- Strategy Explorer -->
      <div class="extra-panel">
        <h4>Strategy Explorer</h4>
        <div style="display:flex;gap:8px;">
          <button onclick="deflectionMission()">üöÄ Deflection Mission
            (simulate)</button>
          <button onclick="evacuationPlan()">üèÉ Evacuation Plan</button>
          <button onclick="compareMitigation()">üîÅ Compare With/Without
            Deflection</button>
        </div>
        <div id="strategyOutput" class="output" style="margin-top:8px;">Strategy
          output will appear here.</div>
      </div>

      <!-- Export -->
      <div class="extra-panel">
        <h4>Export Results</h4>
        <div style="display:flex;gap:8px;">
          <button onclick="exportPDF()">üìÑ Export PDF</button>
          <button onclick="exportMap()">üñºÔ∏è Export Map PNG</button>
          <button onclick="exportJSON()">üíæ Export JSON</button>
        </div>
        <div style="margin-top:8px;">
          <small class="kv"><span>Energy conv:</span><span id="energyConv"
              style="font-weight:700">‚Äî</span></small>
        </div>
      </div>
    </aside>

    <script>
// ---------- Map setup ----------
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap contributors' }).addTo(map);

let impactLat=null, impactLng=null, impactMarker=null;
let lastCircle=null;
let coneGroup = L.layerGroup().addTo(map);
let sampleMarkers = [];
let lastResults = null;

// Map click handler
map.on('click', e => {
  impactLat=e.latlng.lat; impactLng=e.latlng.lng;
  if(impactMarker) map.removeLayer(impactMarker);
  impactMarker=L.marker([impactLat,impactLng]).addTo(map).bindPopup("Selected Impact Location").openPopup();
  // clear previous visuals
  clearCone();
  document.getElementById('output').innerText = 'Impact set at ' + impactLat.toFixed(4) + ', ' + impactLng.toFixed(4) + '. You can generate cone or run simulate.';
});

// 3D model picker
const modelPicker = document.getElementById('modelPicker');
const viewer = document.getElementById('asteroidViewer');
modelPicker.addEventListener('change',()=>{viewer.src=modelPicker.value;});

// ---------------- Physics / Utility functions ----------------
// mass from diameter and density (sphere)
function computeMass(diameter_m, density_kgm3){
  const r = diameter_m/2;
  const vol = (4/3)*Math.PI*Math.pow(r,3); // m^3
  return vol * density_kgm3; // kg
}
// energy J, kilotons, megatons
function energyFromMassVelocity(massKg, velMps){
  const E = 0.5 * massKg * velMps * velMps; // Joules
  const kt = E / 4.184e12; // kilotons of TNT
  const mt = E / 4.184e15; // megatons of TNT
  return {joules: E, kilotons: kt, megatons: mt};
}
// simple airburst vs ground check (rough heuristic)
function willAirburst(diameter_m, velocity_mps, density){
  // small & low density -> likely airburst; this is a heuristic for demo only
  const strengthThreshold = 1e6; // arbitrary
  const mass = computeMass(diameter_m, density);
  const E = 0.5*mass*velocity_mps*velocity_mps;
  // bigger E -> ground impact more probable. This is just for demo.
  return E < strengthThreshold * Math.pow(diameter_m,2);
}
// simple damage radius model from energy (empirical-ish for demo): R_km ~ c * (E_mt)^(1/3)
function damageRadiusKm(mt){
  const c = 5.5; // scaling chosen to make numbers sensible in demo
  return c * Math.pow(Math.max(0.0001, mt), 1/3);
}
// severity color from MT
function severityColor(mt){
  if(mt > 10) return '#e74c3c';
  if(mt > 1) return '#f39c12';
  if(mt > 0.05) return '#f1c40f';
  return '#2ecc71';
}

// great-circle offset: returns lat,lng given bearing and distance_km
function destinationPoint(lat, lon, bearingDeg, distanceKm){
  // Haversine destination
  const R = 6371; // earth radius km
  const br = bearingDeg * Math.PI/180;
  const lat1 = lat * Math.PI/180;
  const lon1 = lon * Math.PI/180;
  const dR = distanceKm / R;
  const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dR) + Math.cos(lat1)*Math.sin(dR)*Math.cos(br));
  const lon2 = lon1 + Math.atan2(Math.sin(br)*Math.sin(dR)*Math.cos(lat1), Math.cos(dR)-Math.sin(lat1)*Math.sin(lat2));
  return [lat2*180/Math.PI, lon2*180/Math.PI];
}

// ---------------- NEO fetch (simple) ----------------
async function fetchNEO(){
  const id = document.getElementById('neoId').value.trim();
  const key = document.getElementById('nasaKey').value.trim() || 'DEMO_KEY';
  if(!id){ alert('Enter a NEO name or ID first'); return; }
  // Try NEO lookup endpoint (if numeric id) otherwise use browse/search (demo-friendly)
  // NOTE: DEMO_KEY has rate limits; for production register for a key.
  try{
    let url = '';
    if(/^\d+$/.test(id)){
      url = `https://api.nasa.gov/neo/rest/v1/neo/${id}?api_key=${encodeURIComponent(key)}`;
    } else {
      // fallback: search by name via browse (we'll fetch first match) - not ideal but OK for demo
      url = `https://api.nasa.gov/neo/rest/v1/neo/browse?api_key=${encodeURIComponent(key)}&size=20`;
    }
    const res = await fetch(url);
    if(!res.ok) throw new Error('NEO fetch failed: ' + res.status);
    const data = await res.json();
    let neo = null;
    if(data.id && data.name){ neo = data; }
    else if(data.near_earth_objects && data.near_earth_objects.length){
      // try find by name substring
      neo = data.near_earth_objects.find(n => n.name.toLowerCase().includes(id.toLowerCase())) || data.near_earth_objects[0];
    }
    if(!neo){ document.getElementById('output').innerText = 'NEO not found in demo browse results.'; return; }

    // fill some demo fields - we don't have direct orbital propagation here.
    // We'll set diameter (estimated), velocity approx from close_approach_data if exists.
    let estDiam = 100;
    if(neo.estimated_diameter && neo.estimated_diameter.meters){
      estDiam = (neo.estimated_diameter.meters.estimated_diameter_min + neo.estimated_diameter.meters.estimated_diameter_max)/2;
    }
    document.getElementById('size').value = estDiam.toFixed(1);

    // try to get approach velocity in km/s
    if(neo.close_approach_data && neo.close_approach_data.length){
      const cad = neo.close_approach_data[0];
      const relVelKps = parseFloat(cad.relative_velocity && cad.relative_velocity.kilometers_per_second) || 20;
      document.getElementById('velocity').value = relVelKps.toFixed(2);
    }

    document.getElementById('output').innerText = `Fetched NEO: ${neo.name} (id ${neo.id})\nEstimated diameter set to ${estDiam.toFixed(1)} m.\nUse "Generate Cone" to create a demo uncertainty cone and click map to choose impact point.`;
    // optionally update model selection if name matches
    if(neo.name.toLowerCase().includes('bennu')) viewer.src = modelPicker.querySelector('option[value*="Bennu"]').value;
  }catch(err){
    console.error(err);
    document.getElementById('output').innerText = 'NEO fetch failed (demo). See console for details.\nYou can still run local simulations.';
  }
}

// ---------------- Uncertainty cone (demo Monte Carlo) ----------------
function clearCone(){
  coneGroup.clearLayers();
  sampleMarkers.forEach(m => map.removeLayer(m));
  sampleMarkers = [];
}
function generateUncertaintyCone(){
  if(impactLat===null){ alert('Click map to set an impact location first'); return; }
  clearCone();
  const uncertaintyDeg = parseFloat(document.getElementById('uncertaintyDeg').value) || 5;
  const distanceKm = 500; // length of cone for demo
  const steps = 36;
  // draw cone fan (demo)
  const conePoints = [];
  for(let b=-uncertaintyDeg; b<=uncertaintyDeg; b += (uncertaintyDeg*2/steps)){
    const bearing = 0 + b; // we'll treat 0 as north for demo; a real propagation uses orbital direction
    const pt = destinationPoint(impactLat, impactLng, bearing, distanceKm);
    conePoints.push(pt);
  }
  // draw polygon by connecting points + impact point
  const poly = L.polygon([[impactLat, impactLng], ...conePoints], {color:'#00d4ff', weight:1, fillOpacity:0.05}).addTo(coneGroup);
  map.fitBounds(poly.getBounds().pad(0.6));
  // Monte Carlo sample points inside fan (random)
  const samples = parseInt(document.getElementById('samples').value) || 200;
  for(let i=0;i<samples;i++){
    // random bearing within cone
    const b = (Math.random()*2-1) * uncertaintyDeg;
    const r = Math.random() * distanceKm;
    const samplePt = destinationPoint(impactLat, impactLng, b, r);
    const m = L.circleMarker(samplePt, {radius:3, color:'#00d4ff', opacity:0.4}).addTo(map);
    sampleMarkers.push(m);
  }
  document.getElementById('output').innerText = `Generated demo uncertainty cone ¬±${uncertaintyDeg}¬∞ with ${samples} samples.\n(Use "Simulate Impact" to compute energy & damage for the selected impact point.)`;
}

// ---------------- Simulation & visualization ----------------
function simulate(){
  if(impactLat===null || impactLng===null){ alert('Click on map to set impact first (left)'); return; }

  const diameter = parseFloat(document.getElementById('size').value) || 100;
  const density = parseFloat(document.getElementById('densityInput').value) || 3000;
  const velocityKps = parseFloat(document.getElementById('velocity').value) || 20;
  const angleDeg = parseFloat(document.getElementById('angle').value) || 45;
  const popDensity = parseFloat(document.getElementById('popDensity').value) || 1000;
  const deflectDv = parseFloat(document.getElementById('deflect').value) || 0;
  const angleRad = angleDeg * Math.PI/180;

  // Apply deflection: reduce relative velocity by some small amount (simple demo model)
  // In reality deflection changes orbit; here Œîv reduces impact velocity magnitude for demo
  const velocity_mps = Math.max(0.1, (velocityKps * 1000) - deflectDv);

  const mass = computeMass(diameter, density);
  const E = energyFromMassVelocity(mass, velocity_mps);
  // coupling factor (how much energy couples to atmosphere/ground) depends on angle and other factors.
  const coupling = Math.max(0.15, Math.sin(angleRad)); // demo heuristic
  const effectiveMt = E.megatons * coupling;

  // damage radius and affected population (we use area * popDensity)
  const damageKm = damageRadiusKm(effectiveMt);
  const areaKm2 = Math.PI * Math.pow(damageKm,2);
  const affectedPop = Math.round(areaKm2 * popDensity); // absolute people
  const affectedPopDisplay = affectedPop >= 1e6 ? (affectedPop/1e6).toFixed(2) + ' million' : affectedPop.toLocaleString();

  // severity color & draw circle
  const color = severityColor(effectiveMt);
  if(lastCircle) map.removeLayer(lastCircle);
  lastCircle = L.circle([impactLat,impactLng], {radius: damageKm*1000, color: color, fillOpacity:0.12}).addTo(map);

  // put results in UI
  const out = [];
  out.push('Impact Results ‚Äî Meteor Madness (demo)');
  out.push('-------------------------------------');
  out.push(`Location: ${impactLat.toFixed(4)}, ${impactLng.toFixed(4)}`);
  out.push(`Diameter: ${diameter.toFixed(2)} m`);
  out.push(`Density: ${density.toFixed(0)} kg/m¬≥`);
  out.push(`Mass: ${mass.toExponential(3)} kg`);
  out.push(`Velocity (post-deflection): ${(velocity_mps/1000).toFixed(3)} km/s`);
  out.push(`Impact angle: ${angleDeg}¬∞`);
  out.push(`Raw Energy: ${E.megatons.toFixed(4)} Mt TNT`);
  out.push(`Coupling factor (heuristic): ${coupling.toFixed(2)}`);
  out.push(`Effective energy (coupled): ${effectiveMt.toFixed(4)} Mt TNT`);
  out.push(`Estimated damage radius: ${damageKm.toFixed(2)} km`);
  out.push(`Estimated affected area: ${areaKm2.toFixed(1)} km¬≤`);
  out.push(`Estimated population affected (using pop density ${popDensity}/km¬≤): ${affectedPopDisplay}`);
  out.push('');
  out.push('Notes: This demo uses simplified heuristics and random uncertainty cone sampling.');
  document.getElementById('output').innerText = out.join('\n');

  // show energy conversion field
  document.getElementById('energyConv').innerText = `${(E.kilotons).toFixed(2)} kt ‚Äî ${E.megatons.toFixed(4)} Mt`;

  // store last results for export / comparison
  lastResults = {
    location: {lat: impactLat, lng: impactLng},
    diameter_m: diameter,
    density_kg_m3: density,
    mass_kg: mass,
    velocity_m_s: velocity_mps,
    angle_deg: angleDeg,
    energy_Mt: E.megatons,
    effective_energy_Mt: effectiveMt,
    damageRadius_km: damageKm,
    affected_area_km2: areaKm2,
    affected_population: affectedPop,
    popDensity_per_km2: popDensity,
    deflection_dv_m_s: parseFloat(document.getElementById('deflect').value || 0),
    timestamp: new Date().toISOString()
  };
}

// ---------------- Strategy functions ----------------
function deflectionMission(){
  // demo: show simple forecasted Œîv effect
  const dv = parseFloat(document.getElementById('deflect').value || 0);
  document.getElementById('strategyOutput').innerText = `Deflection mission configured with Œîv = ${dv} m/s.\nSimulating effect... (In this demo Œîv is subtracted from approach velocity and simulation recomputed.)\nPress "Simulate Impact" to recompute results with this deflection.`;
}

function evacuationPlan(){
  if(!lastResults){ alert('Run a simulation first to create an evacuation plan.'); return; }
  const r = Math.max(20, Math.round(lastResults.damageRadius_km * 1.2)); // buffer
  const pop = lastResults.affected_population;
  const s = `Evacuation Plan (demo):
 - Evacuate population within ${r} km of predicted impact point.
 - Estimated people to move: ${pop.toLocaleString()}
 - Prioritize hospitals, schools, elder care, and transit hubs.
 - Stage supplies upwind and 50-100 km outside the buffer.
 (This is a demo plan; integrate local emergency maps & authorities for real plans.)`;
  document.getElementById('strategyOutput').innerText = s;
}

function compareMitigation(){
  if(!lastResults){ alert('Run a simulation first to compare mitigation.'); return; }
  const baseline = {...lastResults};
  // simulate strong deflection (e.g., Œîv = 300 m/s)
  const dvDemo = 300;
  const velocityNew = Math.max(0.1, (baseline.velocity_m_s) - dvDemo);
  const E2 = energyFromMassVelocity(baseline.mass_kg, velocityNew);
  const coupling = Math.max(0.15, Math.sin(baseline.angle_deg * Math.PI/180));
  const effective2 = E2.megatons * coupling;
  const damage2 = damageRadiusKm(effective2);
  const pop2 = Math.round(Math.PI * Math.pow(damage2,2) * baseline.popDensity_per_km2);
  const diff = baseline.affected_population - pop2;
  const txt = `Comparison (demo):
 - Baseline affected pop: ${baseline.affected_population.toLocaleString()}
 - After Œîv = ${dvDemo} m/s, affected pop: ${pop2.toLocaleString()}
 - Estimated people saved (demo): ${diff.toLocaleString()}
Note: this is a simplified demonstration ‚Äî real deflection modeling requires precise orbital propagation and long-lead time planning.`;
  document.getElementById('strategyOutput').innerText = txt;
}

// ---------------- Exporters ----------------
function exportJSON(){
  if(!lastResults){ alert('Run simulation first'); return; }
  const blob = new Blob([JSON.stringify(lastResults, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'impact_results.json'; a.click();
  URL.revokeObjectURL(url);
}

function exportPDF(){
  if(!lastResults){ alert('Run simulation first'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  doc.setFontSize(16);
  doc.text("Meteor Madness ‚Äî Impact Report (demo)", 40, 60);
  doc.setFontSize(11);
  const txt = document.getElementById('output').innerText + "\n\n" + document.getElementById('strategyOutput').innerText;
  // split text into lines
  const lines = doc.splitTextToSize(txt, 520);
  doc.text(lines, 40, 90);
  doc.save('impact_report.pdf');
}

function exportMap(){
  html2canvas(document.getElementById('map')).then(canvas=>{
    const link=document.createElement('a');
    link.download="map.png";
    link.href=canvas.toDataURL("image/png");
    link.click();
  });
}

// ---------------- UI bindings ----------------
document.getElementById('deflect').addEventListener('input', (ev)=>{
  document.getElementById('deflectVal').innerText = `Œîv = ${ev.target.value} m/s`;
});

// ---------------- Small polish: remove cone/markers on map clear if user moves ----------------
map.on('movestart', ()=>{ /* optional cleanup if needed */ });

// ---------------- End ----------------
</script>
  </body>
</html>
